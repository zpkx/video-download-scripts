# 视频下载器使用说明

一个功能强大且灵活的视频下载工具，基于 yt-dlp 构建，支持 YAML 配置、分类下载和自动配置检测。

## ✨ 主要功能

- **YAML 配置支持**：使用易于编辑的 YAML 文件进行配置
- **自动配置检测**：自动检测并加载 `config.yaml` 配置文件
- **分类下载管理**：将下载内容按类别组织，使用独立的输出目录
- **多种输入方式**：支持 YAML 配置文件和纯文本 URL 列表
- **仅信息模式**：仅提取视频元数据，不进行下载
- **延迟管理**：可配置下载间隔，避免触发速率限制
- **Cookie 支持**：自动检测 Cookie 文件，支持需要登录的内容
- **详细日志记录**：完整的下载进度和错误日志

## 🚀 快速开始

### 安装

1. 克隆或下载此项目
2. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```

### 基本使用

```bash
# 下载单个视频
python video_downloader.py "https://example.com/video"

# 从 YAML 配置文件下载
python video_downloader.py --file urls.yaml

# 从纯文本文件下载
python video_downloader.py --file urls.txt

# 仅获取视频信息（不下载）
python video_downloader.py --info-only "https://example.com/video"
```

## 📁 配置说明

### 自动配置功能

脚本会自动在当前目录查找 `config.yaml` 或 `config.yml` 文件，并从中加载 yt-dlp 选项。无需手动指定配置文件！

### YAML 配置格式

#### URL 配置文件 (`urls.yaml`)

```yaml
# 全局设置，应用到所有分类
global_settings:
  default_quality: "best"
  default_delay_range: [5, 10]
  default_output_path: "./downloads"

# 分类定义
categories:
  纪录片:
    output_path: "./downloads/纪录片"
    quality: "1080p"
    urls:
      - https://example.com/doc1
      - https://example.com/doc2
  
  教程视频:
    output_path: "./downloads/教程"
    urls:
      - https://example.com/tutorial1
      - https://example.com/tutorial2
  
  动漫番剧:
    output_path: "./downloads/动漫"
    subtitle_langs: ["zh-CN", "zh-TW"]
    urls:
      - https://example.com/anime1
      - https://example.com/anime2
```

#### yt-dlp 选项配置 (`config.yaml`)

```yaml
# 视频格式和质量设置
format: "bestvideo[height>=1080]+bestaudio/best"
merge_output_format: "mp4"

# 元数据和字幕设置
writeinfojson: true
writesubtitles: true
writeautomaticsub: true
subtitleslangs: ["zh-CN", "zh-TW", "en"]
embed_subs: true
writethumbnail: true

# 错误处理设置
ignoreerrors: true
retries: 3
fragment_retries: 3
```

## 📖 命令行选项

```
使用方法: video_downloader.py [-h] [-f FILE] [-o OUTPUT] 
                              [-q {low,medium,high,best}] [--delay-seconds DELAY_SECONDS]
                              [--delay-max DELAY_MAX] [--info-only] [--config CONFIG]
                              [urls ...]

位置参数:
  urls                  要下载的视频 URL

可选参数:
  -h, --help            显示帮助信息
  -f FILE, --file FILE  YAML 配置文件或纯文本 URL 文件
  -o OUTPUT, --output OUTPUT
                        输出目录（默认：./downloads）
  -q {low,medium,high,best}, --quality {low,medium,high,best}
                        视频质量（默认：best）
  --delay-seconds DELAY_SECONDS
                        下载间最小延迟秒数（默认：5）
  --delay-max DELAY_MAX
                        下载间最大延迟秒数（默认：15）
  --info-only           仅提取视频信息（不下载）
  --config CONFIG       yt-dlp 选项的 YAML 配置文件（自动检测 config.yaml）
```

## 🎯 使用示例

### 分类下载

创建 `urls.yaml` 文件：
```yaml
categories:
  动漫:
    output_path: "./downloads/动漫"
    urls:
      - https://www.bilibili.com/bangumi/play/ep1234567
      - https://www.bilibili.com/bangumi/play/ep1234568
  
  电影:
    output_path: "./downloads/电影"
    quality: "best"
    urls:
      - https://example.com/movie1
```

运行下载器：
```bash
python video_downloader.py --file urls.yaml
```

### 自定义 yt-dlp 配置

创建 `config.yaml` 文件，设置您喜欢的 yt-dlp 选项：
```yaml
format: "bestvideo[height<=720]+bestaudio/best"
writesubtitles: true
subtitleslangs: ["zh-CN"]
```

脚本会自动加载此配置！

### 仅信息模式

提取元数据而不下载：
```bash
python video_downloader.py --info-only "https://www.bilibili.com/video/BV1234567890"
```

### 多个 URL

```bash
python video_downloader.py "url1" "url2" "url3" --output ./我的下载
```

## 🗂️ 文件结构

```
video-download-scripts/
├── video_downloader.py     # 主脚本
├── requirements.txt        # Python 依赖
├── config.yaml            # yt-dlp 选项（自动加载）
├── urls.yaml              # 分类 URL 配置
├── cookies.txt            # 浏览器 Cookie（可选）
├── downloads/             # 默认下载目录
└── video_download.log     # 下载日志
```

## 🔧 配置文件说明

### 支持的 Cookie 文件
脚本会自动从以下位置检测 Cookie：
- `cookies.txt`
- `www.bilibili.com_cookies.txt`
- `~/cookies.txt`
- `~/Downloads/cookies.txt`

### 兼容性说明
- 仍支持纯文本 URL 文件（`.txt`）
- 现有工作流程将继续正常工作

## 📋 质量选项

- **low**：低质量，文件较小
- **medium**：平衡质量和大小
- **high**：高质量
- **best**：最佳可用质量（默认）

## 🛠️ 高级功能

### 延迟配置
控制下载速度以避免速率限制：
```bash
# 5-15 秒随机延迟
python video_downloader.py --delay-seconds 5 --delay-max 15 --file urls.yaml
```

### 自定义输出目录
```bash
python video_downloader.py --output ./自定义文件夹 "https://example.com/video"
```

### 多个配置文件
```bash
# 使用特定配置文件
python video_downloader.py --config my_config.yaml --file urls.yaml
```

## 📝 日志记录

所有下载活动都会记录到 `video_download.log` 文件中，包含时间戳和详细信息：
- 下载进度
- 错误和警告
- 配置加载情况
- 文件检测信息

## 🎨 分类配置高级选项

在 `urls.yaml` 中可以为每个分类设置特殊选项：

```yaml
categories:
  音乐:
    output_path: "./downloads/音乐"
    extract_audio: true          # 仅提取音频
    audio_format: "mp3"          # 音频格式
    urls:
      - https://example.com/music1

  高清视频:
    output_path: "./downloads/高清"
    quality: "best"
    subtitle_langs: ["zh-CN"]    # 字幕语言
    embed_thumbnail: true        # 嵌入缩略图
    urls:
      - https://example.com/hd1
```

## 🚨 常见问题解决

### 常见问题

1. **没有视频下载**：检查是否存在 cookies.txt 文件以访问需要登录的内容
2. **配置未加载**：确保 `config.yaml` 与脚本在同一目录
3. **网络错误**：使用 `--delay-seconds` 增加下载间隔

### 调试模式

查看详细调试信息，请检查 `video_download.log` 文件或运行时查看详细输出。

## 📄 B站使用说明

### Cookie 获取方法
1. 在浏览器中登录 B站
2. 使用浏览器扩展（如 Get cookies.txt）导出 Cookie
3. 将文件保存为 `cookies.txt` 或 `www.bilibili.com_cookies.txt`

### B站链接格式
支持以下格式：
- `https://www.bilibili.com/video/BV1234567890`
- `https://www.bilibili.com/bangumi/play/ep1234567`
- `https://www.bilibili.com/bangumi/play/ss12345`

## ⚠️ 使用注意事项

- 请遵守内容创作者的版权和平台服务条款
- 合理使用下载功能，不要给服务器造成过大压力
- 建议设置适当的下载延迟

## 🤝 贡献

欢迎提交问题、功能请求或改进建议来完善这个工具！
